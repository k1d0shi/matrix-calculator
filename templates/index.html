<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–∞—Ç—Ä–∏—Ü</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* –ù–µ–±–æ–ª—å—à–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —à–∞–≥–∞/–∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ –∏ –∫–Ω–æ–ø–∫–∏ —Ä–µ—à–µ–Ω–∏—è */
        .result-container {
            width: 80%;
            margin: 20px auto;
            text-align: center;
        }
        .solution-toggle {
            display: inline-block;
            margin: 12px 0;
            cursor: pointer;
            color: #ffffff;
            background: #4CAF50;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 600;
        }
        .solution-panel {
            width: 100%;
            max-width: 900px;
            margin: 10px auto 0;
            text-align: left;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            display: none; /* —Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            background: #fafafa;
        }
        .solution-panel ol {
            margin: 0;
            padding-left: 20px;
        }
        .solution-panel li {
            margin: 6px 0;
            line-height: 1.4;
        }
        .error-text {
            color: #c0392b;
            font-weight: 700;
            margin-top: 10px;
        }
        table.result-table {
            margin: 12px auto;
            border-collapse: collapse;
        }
        table.result-table td {
            border: 1px solid #444;
            padding: 8px 14px;
            font-size: 16px;
        }
    </style>
</head>
<body>
<header>
    <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–∞—Ç—Ä–∏—Ü</h1>
</header>

<main>
    <div class="matrix-container" style="display: flex; justify-content: space-between; align-items: center; width: 80%; margin: 20px auto; position: relative;">
        <div class="matrix left-matrix">
            <h2>–ú–∞—Ç—Ä–∏—Ü–∞ A</h2>
            <label>–†–∞–∑–º–µ—Ä:
                <select id="sizeA" onchange="generateMatrix('A')">
                    <option value="2">2x2</option>
                    <option value="3" selected>3x3</option>
                    <option value="4">4x4</option>
                </select>
            </label>
            <div id="matrixA"></div>
        </div>

        <button onclick="swapMatrices()" class="swap-button" style="position:absolute; left:50%; top:45%; transform:translate(-50%, -50%); font-size:30px; width:70px; height:70px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; padding:0;">
            üîÅ
        </button>

        <div class="matrix right-matrix">
            <h2>–ú–∞—Ç—Ä–∏—Ü–∞ B</h2>
            <label>–†–∞–∑–º–µ—Ä:
                <select id="sizeB" onchange="generateMatrix('B')">
                    <option value="2">2x2</option>
                    <option value="3" selected>3x3</option>
                    <option value="4">4x4</option>
                </select>
            </label>
            <div id="matrixB"></div>
        </div>
    </div>

    <div class="operation" style="text-align:center; margin-top: 10px;">
        <label>–û–ø–µ—Ä–∞—Ü–∏—è:
            <select id="operation">
                <option value="add">A + B (—Å–ª–æ–∂–µ–Ω–∏–µ)</option>
                <option value="sub">A - B (–≤—ã—á–∏—Ç–∞–Ω–∏–µ)</option>
                <option value="mul">A √ó B (—É–º–Ω–æ–∂–µ–Ω–∏–µ)</option>

                <option value="transposeA">A·µÄ (—Ç—Ä–∞–Ω—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ A)</option>
                <option value="transposeB">B·µÄ (—Ç—Ä–∞–Ω—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ B)</option>

                <option value="rankA">–†–∞–Ω–≥ (A)</option>
                <option value="rankB">–†–∞–Ω–≥ (B)</option>

                <option value="detA">det(A)</option>
                <option value="detB">det(B)</option>

                <option value="invA">A‚Åª¬π (–æ–±—Ä–∞—Ç–Ω–∞—è A)</option>
                <option value="invB">B‚Åª¬π (–æ–±—Ä–∞—Ç–Ω–∞—è B)</option>
            </select>
        </label>
        <button onclick="calculate()" style="margin-left:10px; padding:8px 14px; font-weight:600;">–í—ã—á–∏—Å–ª–∏—Ç—å</button>
    </div>

    <!-- –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –∫–Ω–æ–ø–∫–∏ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ—à–µ–Ω–∏–µ" -->
    <div id="resultArea" class="result-container" aria-live="polite"></div>
</main>

<script>
    // --- –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π –º–∞—Ç—Ä–∏—Ü—ã
    function generateMatrix(id) {
        const size = parseInt(document.getElementById("size" + id).value);
        const container = document.getElementById("matrix" + id);
        container.innerHTML = "";
        for (let i = 0; i < size; i++) {
            const row = document.createElement("div");
            row.classList.add("row");
            for (let j = 0; j < size; j++) {
                const input = document.createElement("input");
                input.type = "number";
                input.value = "0";
                input.classList.add("cell");
                input.style.width = "60px";
                input.style.height = "36px";
                input.style.margin = "4px";
                input.style.textAlign = "center";
                row.appendChild(input);
            }
            container.appendChild(row);
        }
        enableAutoSelect();
    }

    // --- –ø–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Ç—Ä–∏—Ü—ã –≤ –≤–∏–¥–µ –º–∞—Å—Å–∏–≤–∞ —á–∏—Å–µ–ª
    function getMatrix(id) {
        const inputs = document.querySelectorAll(`#matrix${id} input`);
        const size = Math.sqrt(inputs.length);
        const matrix = [];
        for (let i = 0; i < size; i++) {
            const row = [];
            for (let j = 0; j < size; j++) {
                const value = parseFloat(inputs[i * size + j].value);
                row.push(isNaN(value) ? 0 : value);
            }
            matrix.push(row);
        }
        return matrix;
    }

    // --- –æ–±–º–µ–Ω –º–∞—Ç—Ä–∏—Ü–∞–º–∏
    function swapMatrices() {
        const aInputs = document.querySelectorAll("#matrixA input");
        const bInputs = document.querySelectorAll("#matrixB input");
        if (aInputs.length !== bInputs.length) {
            alert("–ú–∞—Ç—Ä–∏—Ü—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞!");
            return;
        }
        for (let i = 0; i < aInputs.length; i++) {
            const tmp = aInputs[i].value;
            aInputs[i].value = bInputs[i].value;
            bInputs[i].value = tmp;
        }
        // –ú–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –º–µ—Å—Ç–∞–º–∏
        const sa = document.getElementById("sizeA");
        const sb = document.getElementById("sizeB");
        const tv = sa.value;
        sa.value = sb.value;
        sb.value = tv;
    }

    // --- –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ —Ä–µ–Ω–¥–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ + —à–∞–≥–∏
    async function calculate() {
        const A = getMatrix("A");
        const B = getMatrix("B");
        const operation = document.getElementById("operation").value;

        const resultArea = document.getElementById("resultArea");
        resultArea.innerHTML = "<p>–í—ã—á–∏—Å–ª—è–µ–º...</p>";

        try {
            const response = await fetch("/calculate", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({A, B, operation})
            });

            const data = await response.json();
            if (data.error) {
                resultArea.innerHTML = `<p class="error-text">${data.error}</p>`;
                return;
            }

            // –ü–æ—Å—Ç—Ä–æ–∏–º HTML —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            let html = "";

            // –ö–Ω–æ–ø–∫–∞ —Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ—à–µ–Ω–∏–µ
            html += `<button id="toggleSolution" class="solution-toggle">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ—à–µ–Ω–∏–µ</button>`;

            // –†–µ–∑—É–ª—å—Ç–∞—Ç (—Ç–∞–±–ª–∏—Ü–∞)
            html += `<div id="resultBox">`;
            html += "<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>";
            html += `<table class="result-table">`;
            data.result.forEach(row => {
                html += "<tr>";
                row.forEach(c => {
                    html += `<td>${c}</td>`;
                });
                html += "</tr>";
            });
            html += `</table>`;
            html += `</div>`;

            // –ü–∞–Ω–µ–ª—å —à–∞–≥–æ–≤ (–ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞)
            html += `<div id="solutionPanel" class="solution-panel"><h4>–ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ:</h4><ol>`;
            data.steps.forEach(step => {
                // —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –ø—Ä–æ—Å—Ç—ã–º –∑–∞–º–µ–Ω–æ–π
                const safe = String(step).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                html += `<li>${safe}</li>`;
            });
            html += `</ol></div>`;

            resultArea.innerHTML = html;

            // –ø–æ–¥–∫–ª—é—á–∏–º toggle
            const toggleBtn = document.getElementById("toggleSolution");
            const panel = document.getElementById("solutionPanel");
            toggleBtn.addEventListener("click", function () {
                if (panel.style.display === "none" || panel.style.display === "") {
                    panel.style.display = "block";
                    toggleBtn.textContent = "–°–∫—Ä—ã—Ç—å —Ä–µ—à–µ–Ω–∏–µ";
                    // –º—è–≥–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–∞–Ω–µ–ª–∏
                    panel.scrollIntoView({behavior: "smooth", block: "start"});
                } else {
                    panel.style.display = "none";
                    toggleBtn.textContent = "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ—à–µ–Ω–∏–µ";
                }
            });

        } catch (err) {
            resultArea.innerHTML = `<p class="error-text">–û—à–∏–±–∫–∞: ${err}</p>`;
        }
    }

    // --- –∞–≤—Ç–æ-–≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
    function enableAutoSelect() {
        document.querySelectorAll("input[type='number']").forEach(function (input) {
            // —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∏—Å—å
            input.onfocus = function () { this.select(); };
            // —Ç–∞–∫–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º –∫–ª–∏–∫–µ
            input.ondblclick = function () { this.select(); };
        });
    }

    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    generateMatrix("A");
    generateMatrix("B");
    enableAutoSelect();
</script>
</body>
</html>
